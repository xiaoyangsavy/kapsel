sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/mdc/experimental/provider/registry/ControlRegistry","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor"],function(M,C,X,a){"use strict";var P={};P.apply=function(){X._preprocessMetadataContexts=function(c,s,o){if(s.metadataContexts){for(var k in s.metadataContexts){for(var i=0;i<s.metadataContexts[k].length;i++){P._resolveMetadataContextPath(s.metadataContexts[k][i]);}}}};P._resolveMetadataContextPath=function(m){if(!m){return;}m.path=m.path||'';m.relative=m.path[0]!=='/';if(m.model==''){m.model=undefined;}if(!m.kind){m.kind='field';}m.name=m.name||m.model;};M.prototype._processMetadataContexts=function(m,s){var b,o,k;this._oProviderData={contexts:null,mProvidedProperties:{},mProvidedFunctions:{}};for(var c in m){b=m[c];for(var i=0;i<b.length;i++){o=b[i];if(!P._sanityChecks(o)){return;}k={};k.metadata=o;k.relative=o.relative;this._oProviderData.contexts=this._oProviderData.contexts||{};this._oProviderData.contexts[o.name]=k;}}if(this._oProviderData.contexts){this.attachModelContextChange(P._handleModelContextChange,P);}};M.prototype._cloneMetadataContexts=function(c){if(this._oProviderData){c._oProviderData=this._oProviderData;C.ControlProvider.prepareClone(c);}};};P.registerVisitors=function(A){for(var i=0;i<A.length;i++){var c=A[i].replace(new RegExp("/","g"),".");jQuery.sap.require(c);C.AdapterFactory.cacheAdapterClass(A[i],jQuery.sap.getObject(c));}P.registerTemplating();};P.registerTemplating=function(){var i,n=C.getTemplateNodes();var p=function(o,c){var m=o.getAttribute("metadataContexts");if(m){var b=M.bindingParser(m,null);var r=P._resolveMetadataContextPath(b);if(!r&&b.preprocessModel){P.resolveContexts(o,c,b);}}else{c.visitAttributes(o);}};for(i=0;i<n.length;i++){var N=C.Utils.getNameSpaceInfo(n[i]);a.plugIn(p,N.nameSpace,N.localName);}};P.resolveContexts=function(n,c,m){var o,b=c.getSettings().models[m.preprocessModel];if(!b){var v=c.getViewInfo();var d=sap.ui.getCore().getComponent(v.componentId);b=d?d.oModels[m.preprocessModel]:null;var V={};V[m.model]=b?b.getContext("/"):null;o=c["with"](V,false);}else{o=c;}if(b){var p=m.path;var A=C.AdapterFactory.getAdapter(b,m);A.switchMetaContext(p);var t=C.getTemplatingFunction(n);t(n,o,A);var s=n.getAttribute("metadataContexts");o.visitAttributes(n);if(s){n.setAttribute("metadataContexts",s);}}};P._handleModelContextChange=function(e){var c=e.getSource();for(var k in c._oProviderData.contexts){P._driveWithMetadata(c._oProviderData.contexts[k],c);}};P._driveWithMetadata=function(p,c){if(!p.model){p.model=c.getModel(p.metadata.model);}if(!p.model){jQuery.sap.log.debug("Metadata context cannot be resolved yet");return;}if(p.relative){var s=c.getBindingContext(p.metadata.model);if(!s){jQuery.sap.log.debug("Metadata context cannot be resolved yet");return;}else{p.metadata.path=s+"/"+p.metadata.path;delete p.relative;}}var f=C.getProviderFunction(c);if(f){C.AdapterFactory.requestAdapter(p.model,p.metadata).then(function(A){var r=A.ready();if(r){r.then(function(){A.switchMetaContext(p.metadata.path);f(c,A);});}});}};P._sanityChecks=function(m){if(!m){jQuery.sap.log.warning("No metadata context available");return false;}if(typeof m=="string"){m=M.bindingParser(m);}if(!m.hasOwnProperty("path")||typeof m.path!=="string"){jQuery.sap.log.warning("Metadata context is missing a path or path is not a string");return false;}if(!m.hasOwnProperty("relative")){m.relative=!m.hasOwnProperty("context");}else if(typeof m.relative!=="boolean"){jQuery.sap.log.warning("Metadata relative information must be a boolean");return false;}if(m.hasOwnProperty("context")&&typeof m.context!=="string"){jQuery.sap.log.warning("Metadata context needs no context or a context path of type string");return false;}if(!m.hasOwnProperty("model")){m.model=undefined;jQuery.sap.log.debug("Metadata context is missing a model, assuming undefined model");}if(!m.hasOwnProperty("name")){m.name=m.model;jQuery.sap.log.debug("Metadata context is missing a contexts name, assuming the name of the model");}return true;};return P;});
