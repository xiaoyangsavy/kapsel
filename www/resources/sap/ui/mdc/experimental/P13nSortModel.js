/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/ui/model/json/JSONModel','sap/ui/comp/personalization/Util'],function(q,M,J,P){"use strict";var c=J.extend("sap.ui.mdc.experimental.P13nSortModel",{constructor:function(i,s){J.apply(this,arguments);this._initialize();}});c.prototype._initialize=function(){var t=this.getProperty("/tableItems");var m=t.map(function(p){if(typeof p==="string"){p=sap.ui.getCore().byId(p);}return{columnKey:p.getColumnKey(),selected:p.getSelected(),position:p.getPosition(),text:p.getText(),sortOrder:p.getSortOrder(),comboboxKey:p.getColumnKey(),availableItems:[]};},this);this._sortBySelectedAndPosition(m);this.setProperty("/items",m);this.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay);this.setSizeLimit(1000);this._updateMItemsAvailableItems();};c.prototype.insertModelItemOfIndex=function(i){var m=this.getProperty("/items");m.splice(i+1,0,{columnKey:"(none)",comboboxKey:"(none)",text:"(none)",sortOrder:"Ascending",selected:false,position:undefined,availableItems:[]});this.setProperty("/items",m);this._updateMItemsAvailableItems();this._updateAndSyncMItemsPosition();};c.prototype.removeModelItemOfIndex=function(i){this._updateAndSyncProperties(i,{sortOrder:undefined,selected:false,position:undefined});var m=this.getProperty("/items");m.splice(i,1);if(!m.length){m.splice(0,0,{columnKey:"(none)",comboboxKey:"(none)",text:"(none)",sortOrder:"Ascending",selected:false,position:undefined,availableItems:[]});}this.setProperty("/items",m);this._updateMItemsAvailableItems();this._updateAndSyncMItemsPosition();};c.prototype.replaceModelItemOfIndex=function(i){var m=q.extend(true,{},this.getModelItemByIndex(i));this._updateAndSyncProperties(i,{sortOrder:undefined,selected:false,position:undefined});var I=this.getItemByColumnKey(m.comboboxKey);this.setProperty("/items/"+i+"/columnKey",m.comboboxKey?m.comboboxKey:"(none)");this.setProperty("/items/"+i+"/comboboxKey",m.comboboxKey?m.comboboxKey:"(none)");this.setProperty("/items/"+i+"/text",I?I.getText():"(none)");this._updateAndSyncProperties(i,{sortOrder:m.sortOrder,selected:!!I,position:m.position});this._updateMItemsAvailableItems();};c.prototype._updateItemsPosition=function(){this.getProperty("/availableItems").forEach(function(i){var m=this.getModelItemByColumnKey(i.getColumnKey());if(m){i.setPosition(m.position);}else{i.setPosition(undefined);}},this);};c.prototype.updateProperties=function(i,m){this._updateAndSyncProperties(i,m);};c.prototype._updateAndSyncProperties=function(i,m){var o=this.getModelItemByIndex(i);var I=this.getItemByColumnKey(o.columnKey);if(o){if(m.hasOwnProperty("selected")){this.setProperty("/items/"+i+"/selected",m.selected);if(I){I.setSelected(m.selected);}}if(m.hasOwnProperty("sortOrder")){this.setProperty("/items/"+i+"/sortOrder",m.sortOrder);if(I){I.setSortOrder(m.sortOrder);}}if(m.hasOwnProperty("position")){this.setProperty("/items/"+i+"/position",m.position);if(I){I.setPosition(m.position);}}}};c.prototype._updateAndSyncMItemsPosition=function(){var p=-1;var m=this.getProperty("/items");m.forEach(function(o,i){this._updateAndSyncProperties(i,{position:o.selected===true?++p:undefined});},this);};c.prototype._updateMItemsAvailableItems=function(){if(!this.getProperty("/availableItems")){return;}var a=this.getProperty("/availableItems").filter(function(t){return!this.getModelItemByColumnKey(t.getColumnKey());},this).map(function(t){return{comboboxKey:t.getColumnKey(),text:t.getText()};});this.getProperty("/items").forEach(function(m,i){var C=q.extend(true,[],a);C.splice(0,0,{comboboxKey:m.columnKey,text:m.text});this.setProperty("/items/"+i+"/availableItems",C);},this);};c.prototype.getItemByColumnKey=function(C){var i=this.getProperty("/availableItems").filter(function(I){return I.getColumnKey()===C;});return i[0];};c.prototype.getModelItemByColumnKey=function(C){var m=this.getProperty("/items").filter(function(o){return o.columnKey===C;});return m[0];};c.prototype.getModelItemByIndex=function(i){return this.getProperty("/items/"+i);};c.prototype.getIndexOfModelItem=function(m){return this.getProperty("/items").indexOf(m);};c.prototype.selectModelItem=function(i,I){var m=this.getModelItemByIndex(i);this._updateAndSyncProperties(i,{selected:I});this._updateAndSyncMItemsPosition();var a=this.getProperty("/items");var b=this._getSelectedModelItemsBetween(m,a[0]);if(b.length&&b[0].position>m.position){this.moveModelItemPosition(m,b[0]);}else{b=this._getSelectedModelItemsBetween(m,a[a.length-1]);if(b.length&&b[0].position<m.position){this.moveModelItemPosition(m,b[0]);}}};c.prototype.moveModelItem=function(i,I){var m=this.getModelItemByIndex(i);var o=this.getModelItemByIndex(I);if(!m||!o){return;}var a=this.getProperty("/items");var i=a.indexOf(m);var I=a.indexOf(o);if(i<0||I<0||i>a.length-1||I>a.length-1){return;}var b=a.splice(i,1)[0];a.splice(I,0,b);this.setProperty("/items",a);};c.prototype.moveModelItemPosition=function(i,I){var m=this.getModelItemByIndex(i);var o=this.getModelItemByIndex(I);var s=this._getSelectedModelItemsBetween(m,o);if(!s.length){return;}var d=this.getProperty("/items");var e=d.indexOf(m);var f=d.indexOf(o);var g=q.extend(true,[],d);g.sort(function(a,b){if(a.position<b.position){return-1;}else if(a.position>b.position){return 1;}else{return 0;}});var h=g.splice(e,1)[0];var p=-1;g.forEach(function(a){a.position=a.selected===true?++p:undefined;});g.splice(f,0,h);p=-1;g.forEach(function(a){a.position=a.selected===true?++p:undefined;});d.forEach(function(a,b){var j=P.getArrayElementByKey("columnKey",a.columnKey,g);this._updateAndSyncProperties(b,{position:j.position});},this);};c.prototype._getSelectedModelItemsBetween=function(m,o){var a=this.getProperty("/items");var i=a.indexOf(m);var I=a.indexOf(o);if(i===I){return[];}var b=[];if(i<I){b=a.slice(i+1,I+1);return b.filter(function(d){return!!d.selected;});}b=a.slice(I,i).reverse();return b.filter(function(d){return!!d.selected;});};c.prototype._sortBySelectedAndPosition=function(m){if(this.getProperty("/preventInitialSort")){return;}m.sort(function(a,b){if(a.selected===true&&(b.selected===false||b.selected===undefined)){return-1;}else if((a.selected===false||a.selected===undefined)&&b.selected===true){return 1;}else if(a.selected===true&&b.selected===true){if(a.position<b.position){return-1;}else if(a.position>b.position){return 1;}else{return 0;}}else if((a.selected===false||a.selected===undefined)&&(b.selected===false||b.selected===undefined)){if(a.text<b.text){return-1;}else if(a.text>b.text){return 1;}else{return 0;}}});};return c;},true);
