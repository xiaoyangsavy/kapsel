/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2017 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','./ExportDialog'],function(q,l,E){'use strict';var S=function(s){this.mSettings=q.extend(true,{},s);};S.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}};S.prototype.onprogress=function(P){q.sap.log.debug("Spreadsheet export: "+P+"% loaded.");};var p=(function(){var r={};for(var k in l.EdmType){r[k.toLowerCase()]=k;}return r;})();var a="Spreadsheet export: ";function v(P){var b=a;var o="odata";var e=".xlsx";P.fileName=P.fileName||'export';if(!q.sap.endsWith(P.fileName,e)){P.fileName+=e;}var d=P.dataSource;if(typeof d==="string"){var c=P.count||1;P.dataSource={dataUrl:d,type:o,count:c};P.count=c;}else if(Array.isArray(d)){var D=d.map(function(r){return q.extend(true,{},r);});P.dataSource={data:D,type:"array"};}else if(d&&d.dataUrl){var s=(d.type||o).toLowerCase();P.dataSource.type=s;if(d.useBatch){}}var f=P&&P.workbook;f.columns.forEach(function(g){g.label=g.label||(g.property instanceof Array?g.property[0]:g.property)||"";var w=g.width;if(typeof w==="string"){var W=w.toLowerCase();w=parseFloat(W);if(W.indexOf("em")>0){w=w*2;}else if(W.indexOf("px")>0){w=w/8;}}if(isNaN(w)||w<1){w=10;}if(g.label.length<30){w=Math.max(g.label.length,w);}g.width=Math.round(w);if(g.type){g.type=g.type.toLowerCase();if(!p[g.type]){q.sap.log.error(b+"insupported column property type "+g.type+". Type is reverted to 'string'.");g.type="";}if(g.type==="currency"&&!g.unitProperty){q.sap.log.error(b+"missing unit property for currency column. Type is reverted to 'string'.");g.type="";}}var h=g.scale;if(g.type==="number"&&isNaN(h)&&h!=="variable"){q.sap.log.warning(b+"scale parameter for numerical column configuration is missing.");}if(typeof h==="string"){h=parseInt(h,10);}if(isNaN(h)){h=null;}g.scale=h;var t=(g.textAlign+"").toLowerCase();if(t!==""&&["left","right","center","begin","end"].indexOf(t)==-1){q.sap.log.warning(b+"incorrect column alignment property: "+t+". Default alignment is used.");t="";}g.textAlign=t;});}S.prototype.build=function(){var s=this;var P=q.extend(true,{},this.mSettings);v(P);return new Promise(function(r,R){var b;function o(m){if(!isNaN(m.progress)){if(b){b.updateStatus(m.progress);}s.onprogress(m.progress);}if(m.error||m.finish){s.process=null;if(b){b.finish();}if(m.error){R(m.error);E.showErrorMessage(m.error);}else if(m.finish){r();}}}if(s.process){R("Cannot start export: the process is already running");return;}if(P.showProgress!==false){b=E.getProgressDialog();b.oncancel=function(){return s.process&&s.process.cancel();};b.open();}s.process=sap.ui.requireSync("sap/ui/export/SpreadsheetExport").execute(P,o);});};return S;},true);
