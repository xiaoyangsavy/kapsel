/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["./library",'sap/ui/mdc/XMLComposite',"sap/ui/mdc/base/ODataSuggestProvider","sap/ui/mdc/base/OperatorSuggestProvider","sap/ui/mdc/base/FixedValueListProvider","sap/ui/model/json/JSONModel","sap/ui/mdc/ValueHelpDialog","sap/ui/mdc/internal/common/Helper",'sap/ui/model/odata/v4/AnnotationHelper'],function(L,X,O,a,F,J,V,C){"use strict";var b=X.extend("sap.ui.mdc.FilterField",{metadata:{designTime:false,specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'}, { model: 'property', path:'',  name: 'property'}"}},properties:{conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false}},events:{},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterfield.FilterField"});b.prototype.getInnerFilterField=function(){return this.get_content().getItems()[1];};b.prototype.init=function(){X.prototype.init.call(this);var i=this.getInnerFilterField();var s=i.getCustomData()[1].getValue()==='true',f=i.getCustomData()[2].getValue()==='true';if(s){new O({control:i,enableFilterSuggest:false,suggest:this.handleSuggest.bind(this)});}else if(f){new F({control:i,enableFilterSuggest:true,suggest:this.handleSuggest.bind(this)});}};b.prototype.handleSuggest=function(p,e){var i=this.getInnerFilterField();var f=this;var I=e.getSource();var E=i.data("entitySetName");var m=f.getModel().getMetaModel();var s,B={};var c=i.getCustomData()[2].getValue()==='true';if(!c){s=m.getObject("/"+E+"@Org.OData.Capabilities.V1.SearchRestrictions");if(!s||s.Searchable||s.Searchable===undefined){B={$search:e.getParameters().suggestValue};}else{return;}}if(this.bSuggestionViewCreated){if(!c){var S=I.getBinding("suggestionRows");if(S){S.changeParameters(B);}}}else{this.bSuggestionViewCreated=true;this._requestValueListMetadata().then(function(v){v.SuggestBindingParameters=JSON.stringify(B);var o=new J(v);var d=sap.ui.view({viewName:"sap.ui.mdc.internal.filterfield.SuggestionList",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{valueList:o.createBindingContext("/")},models:{valueList:o}}}});d.setModel(v.$model);return d.loaded().then(function(){p.setTable(d.getContent()[0]);if(v.__sapfe){if(v.__sapfe.keyPath){p.setKeyPath(v.__sapfe.keyPath);}if(v.__sapfe.descriptionPath){p.setDescriptionPath(v.__sapfe.descriptionPath);}}});});}};b.prototype.handleValueHelpRequest=function(){var i=this.getInnerFilterField();var e=i.data("entitySetName");var f=i.getFieldPath().replace(/\*/g,'');var v=new V({entitySet:e,fieldPath:f});v.setConditionModel(this.getModel(this.getConditionModelName()));this.addDependent(v);v.open();};b.prototype._requestValueListMetadata=function(){var f=this;var I=this.getInnerFilterField();var e=I.data("entitySetName");var s=I.getFieldPath().replace(/\*/g,'');return this.getModel().getMetaModel().requestValueListInfo('/'+e+'/'+s).then(function(v){var p;if(v[""]){p=v[""].Parameters;var m=f.getModel().getMetaModel();var l=m.getObject('/'+e+'/'+s+"@sapui.name");var c=m.getObject("/"+e+"@com.sap.vocabularies.Common.v1.FilterExpressionRestrictions");var o=c&&c.filter(function(d){return d.Property.$PropertyPath===s;});v[""].sTitle=m.getObject("/"+e+"/$Type/"+s+"@com.sap.vocabularies.Common.v1.Label");if(o&&(o.length>0)&&(o[0].AllowedExpressions.$EnumMember.indexOf("SingleValue")>-1)){v[""].sSelectionMode="SingleSelectLeft";v[""].sTitle=L.getText("valuehelp.SINGLE_ITEM_SELECT")+v[""].sTitle;}else{v[""].sSelectionMode="MultiSelect";}for(var i=0;i<p.length;i++){if(p[i].LocalDataProperty&&p[i].LocalDataProperty.$PropertyPath===l){v[""].__sapfe={keyPath:p[i].ValueListProperty,descriptionPath:v[""].$model.getMetaModel().getObject("/"+v[""].CollectionPath+"/"+p[i].ValueListProperty+"@com.sap.vocabularies.Common.v1.Text/$Path")};break;}}return v[""];}else{throw("no unqualified value list found - currently qualified value lists are not considered");}},function(E){throw(E.message);});};b._helper={getFieldPath:function(I,e,f){var m,s,p,t;m=I.getInterface(0).getModel();if(typeof f!=="string"){f=m.getObject(I.getInterface(1).getPath()+"@sapui.name");}if(f.indexOf('/')>-1){s=f.split('/');for(var i=0;i<(s.length-1);i++){p=m.getObject("/"+e+"/"+s.slice(0,(i+1)).join('/'));if(p&&p["$kind"]==="NavigationProperty"&&p["$isCollection"]){s[i]=s[i]+'*';t=true;}}if(t){f=s.join('/');}}return f;},getValueStatePath:function(i,e,f){var _=b._helper.getFieldPath(i,e,f);return"{sap.fe.cm>/fieldPath/"+_+"/valueState}";},getValueStateTextPath:function(i,e,f){var _=b._helper.getFieldPath(i,e,f);return"{sap.fe.cm>/fieldPath/"+_+"/valueStateText}";},isRequiredInFilter:function(p,d){var e,P,i=false,f,m=d.context.getModel(),s=d.context.getPath();e=C._getEntitySetPath(m,s);if(typeof p==="string"){P=p;}else{P=m.getObject(s+"@sapui.name");}f=m.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(f&&f.RequiredProperties){i=f.RequiredProperties.some(function(c){return c.$PropertyPath===P;});}return i;},typeFormatOptions:function(p,d){var f="{",s,m=d.context.getModel(),P=d.context.getPath(),t=m.getObject(P+"/$Type"),T,o;if(t==="Edm.Date"||t==="Edm.DateTimeOffset"||t==="Edm.TimeOfDay"){f+="style: 'medium'";}else if(t==="Edm.Decimal"){s=m.getObject(P+"/$Scale")||0;switch(s){case"floating":f+="decimals: "+(m.getObject(P+"/$Precision")||0);break;case"variable":break;default:f+="decimals: "+s;}}T=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text");if(T){o=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement");if(f.length>1){f+=", ";}if(o&&o.$EnumMember){switch(o.$EnumMember){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":f+="displayFormat: 'ValueDescription'";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":f+="displayFormat: 'Description'";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeparate":f+="displayFormat: 'Value'";break;default:f+="displayFormat: 'DescriptionValue'";}}else{f+="displayFormat: 'DescriptionValue'";}}return f+"}";},typeConstraints:function(p,d){var c="{",s,m,M=d.context.getModel(),P=d.context.getPath(),t=M.getObject(P+"/$Type");if(t==="Edm.Decimal"){s=M.getObject(P+"/$Scale")||0;switch(s){case"floating":c+="decimals: "+(M.getObject(P+"/$Precision")||0);break;case"variable":break;default:c+="decimals: "+s;}}else if(t==="Edm.String"){m=M.getObject(P+"/$MaxLength");if(m){c+="maxLength: "+m;}if(M.getObject(P+"@com.sap.vocabularies.Common.v1.IsUpperCase")){if(c.length>1){c+=", ";}c+="toUpperCase: true";}}return c+"}";},getValueListCollectionEntitySet:function(v){var m=v.getObject();return m.$model.getMetaModel().createBindingContext("/"+m.CollectionPath);},getValueListProperty:function(p){var v=p.getModel();var m=v.getObject("/");return m.$model.getMetaModel().createBindingContext('/'+m.CollectionPath+'/'+p.getObject());}};b._helper.getFieldPath.requiresIContext=true;b._helper.getValueStatePath.requiresIContext=true;b._helper.getValueStateTextPath.requiresIContext=true;return b;},true);
