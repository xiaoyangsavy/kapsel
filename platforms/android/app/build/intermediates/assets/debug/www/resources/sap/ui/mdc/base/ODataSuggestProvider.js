/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["jquery.sap.global","sap/ui/base/Object"],function(q,B){"use strict";var O=B.extend("sap.ui.mdc.base.ODataSuggestProvider",{constructor:function(p){B.apply(this);this._bShowAll=true;this._bShowHint=false;if(p){this._fInit=p.init;this._fSuggest=p.suggest;this._fSelect=p.select;this._bShowAll=p.enableShowAll!==undefined?p.enableShowAll:true;this._bShowHint=p.showHint!==undefined?p.showHint:false;this._maxWidth=p.maxWidth;this._bEnableFilterSuggest=p.enableFilterSuggest;this._keyPath=p.keyPath;this._descriptionPath=p.descriptionPath;if(p.control){this.associateFilterField(p.control);}}}});O.prototype.destroy=function(){this._oFilterField=null;this._oInput=null;this._oTable=null;};O.prototype.getTable=function(){return this._oTable;};O.prototype.setKeyPath=function(k){this._keyPath=k;};O.prototype.setDescriptionPath=function(d){this._descriptionPath=d;};O.prototype.setTable=function(t){this._oTable=t;var m=this._oFilterField.getAggregation("_input");m.removeAllSuggestionColumns();m.removeAllSuggestionRows();if(t){var b=t.getBindingInfo("items");var c=t.getColumns();for(var i=0;i<c.length;i++){var C=c[i].clone();m.addSuggestionColumn(C);}m.setMaxSuggestionWidth(this._maxWidth?this._maxWidth:(c.length*8+2)+"em");m.setModel(t.getModel());m.bindAggregation("suggestionRows",{path:b.path,template:b.template,parameters:b.parameters});}else{m.bindAggregation("suggestionRows",null);}};O.prototype.associateFilterField=function(f){this._oFilterField=f;this._oInput=f.getAggregation("_input");if(!this._oInput){var t=this;setTimeout(function(){t.associateFilterField(f);},100);}if(!(this._oInput instanceof sap.m.MultiInput)){q.sap.log.error("mdc:ODataSuggestProvider","associateFilterField for "+(this._oInput?this._oInput.getId():"none")+" not possible!");return;}this._oInput.setShowSuggestion(true);this._oInput.setEnableSuggestionsHighlighting(false);this._oInput.setFilterSuggests(this._bEnableFilterSuggest);this._oInput.setShowTableSuggestionValueHelp(false);if(this._bShowHint){this._oInput.setPlaceholder("press space to get help");}this._oInput.attachSuggest(function(e){if(this._fInit&&!this.getTable()){this._fInit(this);}if(this._fSuggest){this._fSuggest(this,e);}}.bind(this));this._oInput.setFilterFunction(function(v,i){var s=(v.lastIndexOf(" ")==v.length-1)&&this._bShowAll;v=v.trim();if(s){return true;}return sap.m.Input._DEFAULTFILTER_TABULAR(v,i);}.bind(this));this._oInput.addValidator(function(d){var T=d.text,r=d.suggestionObject,s=this._oInput,b=this._oFilterField.getBinding("conditions"),o=this._oFilterField._getDataType(),a=o.getMetadata().getName(),c,C,F=this._oFilterField.getFieldPath();var D;var k,e,v;if(r){if(this._fSelect){if(this._fSelect(this,d)){return null;}}var g=r.getBindingContext();D=g.getObject();k=this._keyPath&&D[this._keyPath]?D[this._keyPath]:null;e=this._descriptionPath&&D[this._descriptionPath]?D[this._descriptionPath]:null;v="=="+k;q.sap.log.info("mdc:ODataSuggestProvider","validator suggestionObject handled sValue "+v);c=this._oFilterField.getFilterOperatorConfig().getOperator("EEQ");if(c&&c.test(v,o)){C=b.getModel().addCondition(b.getModel().createItemCondition(F,k,e));s.setValue("");this._oFilterField.fireChange({value:C,type:"added",valid:true});}}else{q.sap.log.info("mdc:ODataSuggestProvider","validator check if one suggestionRow exist for "+T);if(s._getIsSuggestionPopupOpen&&s._getIsSuggestionPopupOpen()){var S=s.getSuggestionRows();var n=0,i=-1;S.some(function(I,j){if(I.getVisible()){n++;i=j;}return n>=2;});if(n===1){D=S[i].getBindingContext().getObject();if(this._fSelect){d.suggestionObject=S[i];if(this._fSelect(this,d)){return null;}}k=this._keyPath&&D[this._keyPath]?D[this._keyPath]:null;e=this._descriptionPath&&D[this._descriptionPath]?D[this._descriptionPath]:null;v="=="+k;c=this._oFilterField.getFilterOperatorConfig().getOperator("EEQ");if(c&&c.test(v,o)){C=b.getModel().addCondition(b.getModel().createItemCondition(F,k,e));s.setValue("");this._oFilterField.fireChange({value:C,type:"added",valid:true});return null;}}}q.sap.log.info("mdc:ODataSuggestProvider","validator text handled "+T);var h=this._oFilterField.getFilterOperatorConfig().getMatchingOperators(a,T);if(h.length!==0){c=h[0];C=c.getCondition(T,o);if(C){C.fieldPath=F;b.getModel().addCondition(C);s.setValue("");this._oFilterField.fireChange({value:C,type:"added",valid:true});return null;}}s.setValue("");q.sap.delayedCall(100,this,function(){var v="=="+T;q.sap.log.info("mdc:ODataSuggestProvider","validator EEQ text handling "+v);var c=this._oFilterField.getFilterOperatorConfig().getOperator("EEQ");if(c&&c.test(v,o)){C=b.getModel().addCondition(b.getModel().createItemCondition(F,T,T));this._oFilterField.fireChange({value:C,type:"added",valid:true});}});}return null;}.bind(this));};return O;},true);
