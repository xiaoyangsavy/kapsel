/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

(c) Copyright 2009-2017 SAP SE. All rights reserved
 */
sap.ui.define(["./library",'sap/ui/mdc/XMLComposite','sap/ui/base/ManagedObject','sap/ui/Device',"sap/ui/mdc/internal/common/Helper","sap/ui/mdc/FilterField","sap/m/SearchField",'sap/ui/mdc/base/ConditionModel'],function(L,X,M,D,C,F,S,a){"use strict";var b=X.extend("sap.ui.mdc.FilterBar",{metadata:{designTime:true,specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'},{model: 'sap.fe.deviceModel', path: '/', name: 'sap.fe.deviceModel'}"}},properties:{liveUpdate:{type:"boolean",defaultValue:!D.system.phone,invalidate:"template"},searchOnStart:{type:"boolean",defaultValue:true,invalidate:"template"},filterSummary:{type:"string",defaultValue:"",invalidate:false},enabled:{type:"boolean",defaultValue:true,invalidate:false},conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false},listBindingNames:{type:"string[]",invalidate:false}},events:{search:{},change:{}},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterbar.FilterBar"});var s=function(e){var c=this._getConditionModel(),m=this.getModel(),l,d,f;f=c.applyFilters();if(f&&m.getBindingForReference){var o=this._getSearchControl();if(o){d=o.getValue()||undefined;l=this.getListBindingNames();l.forEach(function(g){m.getBindingForReference(g).then(function(h){h.changeParameters({$search:d});});});}}};b.prototype.init=function(){X.prototype.init.call(this);var t=this;this._bIsReady=false;this.attachSearch(s);this._requestConditionModel().then(function(c){if(!t.bInitialized){t.bInitialized=true;var o=c.bindProperty("/",c.getContext("/"));o.attachChange(t.handleChange.bind(t));if(t.getSearchOnStart()&&t.getEnabled()){t._bIsReady=true;t.fireSearch();}if(!t.getEnabled()){t._getInnerFilterBar().setBusy(true);}}});};b.prototype.onBeforeRendering=function(){this._setFilterSummary();};b.prototype.setEnabled=function(e){this._getInnerFilterBar().setBusy(!e);this.setProperty("enabled",e);if(e){if(this.bInitialized&&this.getSearchOnStart()){this._bIsReady=true;this.fireSearch();}}};b.prototype.isReady=function(){return this._bIsReady;};b.prototype.getAppState=function(){var c=this._getConditionModel(),d=this._getDraftEditStateControl(),o=this._getSearchControl(),A={};if(c){A.conditionModel=c.serialize();}if(d){A.draftEditState=d.getSelectedKey();}if(o){A.search=o.getValue();}return A;};b.prototype.setAppState=function(A){var t=this;return this._requestConditionModel().then(function(c){var d=t._getDraftEditStateControl(),o=t._getSearchControl();if(A.conditionModel){if(c){c.parse(A.conditionModel);}else{throw("app state contains condition model state but condition model not yet set");}}if(A.draftEditState&&d){d.setSelectedKey(A.draftEditState);}if(A.search&&o){o.setValue(A.search);}if(!t.getLiveUpdate()){t.handleGo();}});};b.prototype.handleChange=function(){if(this.getLiveUpdate()&&this.getEnabled()){this.fireSearch();this._setFilterSummary();this.fireChange();}else{this._bIsReady=false;this.fireChange();}};b.prototype.handleSearch=function(e){this.fireSearch();this._setFilterSummary();this.fireChange();};b.prototype.handleSearchChange=function(e){var t=this,i;if(t._iSearchCounter){t._iSearchCounter++;}else{t._iSearchCounter=1;}i=t._iSearchCounter;if(this.getLiveUpdate()){setTimeout(function(){if(i===t._iSearchCounter){t.fireSearch();t._setFilterSummary();t.fireChange();delete t._iSearchCounter;}},400);}else{this._bIsReady=false;this.fireChange();}};b.prototype.handleGo=function(){this._bIsReady=true;this.fireSearch();this._setFilterSummary();this.fireChange();};b.prototype._getInnerFilterBar=function(){return this.get_content();};b.prototype._setFilterSummary=function(){var o=this._getSearchControl(),d=this._getDraftEditStateControl(),c,f="",e=[],i;if(o){c=o.getValue();}if(c){f=L.getText("filterbar.SEARCHBY")+": "+c+((e.length>0)?" | ":"");}if(d&&d.getSelectedKey()!=='0'){e.push(L.getText("filterbar.EDITING_STATUS"));}var g=this._getFilterFieldControls();for(i=0;i<g.length;i++){if(g[i].getConditions().length>0){e.push(g[i].getCustomData()[0].getValue());}}if(e.length>0){f+=L.getText("filterbar.FILTERBY")+" ("+e.length+"): ";for(i=0;i<e.length;i++){f+=((i>0)?', ':'')+e[i];}}if(!f){f=L.getText("filterbar.FILTERBYNONE");}this.setFilterSummary(f);};b.prototype._requestConditionModel=function(){var c=this._getConditionModel(),t=this;if(c){return Promise.resolve(c);}else{return new Promise(function(r){var m=t.getModel();var f=function(){var m,c,n;t.detachModelContextChange(f);c=t.getModel(t.getConditionModelName());if(c){return Promise.resolve(c);}else{m=m||t.getModel();n=t.getListBindingNames();if(n&&m.getBindingForReference){n.forEach(function(N){m.getBindingForReference(N).then(function(l){c=a.getFor(l);this.setModel(c,this.getConditionModelName());r(c);}.bind(this));}.bind(t));}}};if(m){f();}else{t.attachModelContextChange(f);}});}};b.prototype._getConditionModel=function(){return this.getModel(this.getConditionModelName());};b.prototype._getDraftEditStateControl=function(){var c=this._getInnerFilterBar().getContent();var f;for(var i=0;i<c.length;i++){if(!(c[i]instanceof F)&&c[i].getItems){f=c[i].getItems()[1];if(f.getBinding("items")&&f.getBinding("items").getPath()==="/editStates"&&f.getBinding("items").getModel()===f.getModel("$draft")){return f;}}}};b.prototype._getSearchControl=function(){var c=this._getInnerFilterBar().getContent();var f;for(var i=0;i<c.length;i++){f=c[i].getItems()[1];if(f instanceof S){return f;}}};b.prototype._getFilterFieldControls=function(){var c=this._getInnerFilterBar().getContent();var f,d=[];for(var i=0;i<c.length;i++){f=c[i];if(f instanceof F){d.push(f.get_content().getItems()[1]);}}return d;};b._helper={isPropertyFilterable:function(c,p){var e,P,i=false,m=c.getModel(),d=c.getPath();if(m.getObject(d+"@com.sap.vocabularies.UI.v1.Hidden")){return false;}if(m.getObject(d+"@com.sap.vocabularies.UI.v1.HiddenFilter")){return false;}e=C._getEntitySetPath(m,d);if(typeof(p)==="string"){P=p;}else{P=m.getObject(d+"@sapui.name");}if(P.indexOf("/")<0){i=b._helper._isInNonFilterableProperties(m,e,P);}else{i=b._helper._isContextPathFilterable(m,e,P);}return!i;},isNavPropertyFilterable:function(c,n){var e,d,i=false,p=c.getPath(),m=c.getModel();e=C._getEntitySetPath(m,p);d=p.slice(e.length+1);if(d.indexOf("/")<0){i=b._helper._isInNonFilterableProperties(m,e,d);}else{i=b._helper._isContextPathFilterable(m,e,d);}return!i;},_isInNonFilterableProperties:function(m,e,c){var i=false;var A=m.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(A&&A.NonFilterableProperties){i=A.NonFilterableProperties.some(function(p){return p.$NavigationPropertyPath===c||p.$PropertyPath===c;});}return i;},_isContextPathFilterable:function(m,e,c){var d=c.split("/"),i=false,f="";d.some(function(g,h,j){if(f.length>0){f+="/"+g;}else{f=g;}if(h===j.length-1){i=b._helper._isInNonFilterableProperties(m,e,f);}else if(m.getObject(e+"/$NavigationPropertyBinding/"+g)){i=b._helper._isInNonFilterableProperties(m,e,f);f="";e="/"+m.getObject(e+"/$NavigationPropertyBinding/"+g);}return i===true;});return i;},replaceSpecialCharsInId:function(i){return C.replaceSpecialCharsInId(i);}};b._helper.isNavPropertyFilterable.requiresIContext=true;b._helper.isPropertyFilterable.requiresIContext=true;return b;},true);
